/*
 * FIT_PCMD3140.c
 *
 *  Created on: May 19, 2025
 *      Author: fit0354
 */
#include "main.h"
#include "FIT_PCMD3140.h"
#include "FIT_M24C08_EE.h"
#include "FIT_eeprom_pcmd3140_hw_i2c_implemention.h"
#include "FIT_DebugMessage.h"
#include "FIT_SysTick.h"
#include "Command.h"
#include "FIT_LED.h"

const struct PMD3140_Register page0ConfigRegDefault[49]={
		{0x00,0x00},
		{0x01,0x00},
		{0x02,0x01},
		{0x07,0x60},
		{0x08,0x00},
		{0x09,0x00},
		{0x0A,0x00},
		{0x0B,0x00},
		{0x0C,0x20},
		{0x0D,0x00},
		{0x0E,0x00},
		{0x13,0x02},
		{0x14,0x48},
		{0x15,0xFF},
		{0x16,0x10},
		{0x1F,0x40},
		{0x20,0x00},
		{0x21,0x22},
		{0x22,0x41},
		{0x29,0x00},
		{0x2A,0x00},
		{0x2B,0x40},
		{0x2F,0x00},
		{0x32,0x00},
		{0x33,0xFF},
		{0x36,0x00},
		{0x3B,0x60},
		{0x3C,0x40},
		{0x3E,0xC9},
		{0x3F,0x80},
		{0x40,0x00},
		{0x41,0x40},
		{0x43,0xC9},
		{0x44,0x80},
		{0x45,0x00},
		{0x48,0xC9},
		{0x49,0x80},
		{0x4A,0x00},
		{0x4D,0xC9},
		{0x4E,0x80},
		{0x4F,0x00},
		{0x6B,0x01},
		{0x6C,0x60},
		{0x73,0xC0},
		{0x74,0xC0},
		{0x75,0xE0},
		{0x76,0x00},
		{0x77,0x80},
		{0x7E,0x00}
};

struct PMD3140_Register page0StatusReg[6]={
		{0x15,0xFF},
		{0x2A,0x00},
		{0x2F,0x00},
		{0x36,0x00},
		{0x76,0x00},
		{0x77,0x00}
};

struct PMD3140_Register unusedRegister[8]={
		{0x00,0x00},
		{0x15,0xFF},
		{0x2A,0x00},
		{0x2F,0x00},
		{0x36,0x00},
		{0x76,0x00},
		{0x77,0x00},
		{0x7E,0x00}
};

const struct PMD3140_Register page1ConfigRegDefault[2]={
		{0x1E,0x20},
		{0x1F,0x08}
};

const struct PMD3140_Register page2ConfigRegDefault[121]={
		{0x00,0x02},
		{0x08,0x7F},
		{0x09,0xFF},
		{0x0A,0xFF},
		{0x0B,0xFF},
		{0x0C,0x00},
		{0x0D,0x00},
		{0x0E,0x00},
		{0x0F,0x00},
		{0x10,0x00},
		{0x11,0x00},
		{0x12,0x00},
		{0x13,0x00},
		{0x14,0x00},
		{0x15,0x00},
		{0x16,0x00},
		{0x17,0x00},
		{0x18,0x00},
		{0x19,0x00},
		{0x1A,0x00},
		{0x1B,0x00},
		{0x1C,0x7F},
		{0x1D,0xFF},
		{0x1E,0xFF},
		{0x1F,0xFF},
		{0x20,0x00},
		{0x21,0x00},
		{0x22,0x00},
		{0x23,0x00},
		{0x24,0x00},
		{0x25,0x00},
		{0x26,0x00},
		{0x27,0x00},
		{0x28,0x00},
		{0x29,0x00},
		{0x2A,0x00},
		{0x2B,0x00},
		{0x2C,0x00},
		{0x2D,0x00},
		{0x2E,0x00},
		{0x2F,0x00},
		{0x30,0x7F},
		{0x31,0xFF},
		{0x32,0xFF},
		{0x33,0xFF},
		{0x34,0x00},
		{0x35,0x00},
		{0x36,0x00},
		{0x37,0x00},
		{0x38,0x00},
		{0x39,0x00},
		{0x3A,0x00},
		{0x3B,0x00},
		{0x3C,0x00},
		{0x3D,0x00},
		{0x3E,0x00},
		{0x3F,0x00},
		{0x40,0x00},
		{0x41,0x00},
		{0x42,0x00},
		{0x43,0x00},
		{0x44,0x7F},
		{0x45,0xFF},
		{0x46,0xFF},
		{0x47,0xFF},
		{0x48,0x00},
		{0x49,0x00},
		{0x4A,0x00},
		{0x4B,0x00},
		{0x4C,0x00},
		{0x4D,0x00},
		{0x4E,0x00},
		{0x4F,0x00},
		{0x50,0x00},
		{0x51,0x00},
		{0x52,0x00},
		{0x53,0x00},
		{0x54,0x00},
		{0x55,0x00},
		{0x56,0x00},
		{0x57,0x00},
		{0x58,0x7F},
		{0x59,0xFF},
		{0x5A,0xFF},
		{0x5B,0xFF},
		{0x5C,0x00},
		{0x5D,0x00},
		{0x5E,0x00},
		{0x5F,0x00},
		{0x60,0x00},
		{0x61,0x00},
		{0x62,0x00},
		{0x63,0x00},
		{0x64,0x00},
		{0x65,0x00},
		{0x66,0x00},
		{0x67,0x00},
		{0x68,0x00},
		{0x69,0x00},
		{0x6A,0x00},
		{0x6B,0x00},
		{0x6C,0x7F},
		{0x6D,0xFF},
		{0x6E,0xFF},
		{0x6F,0xFF},
		{0x70,0x00},
		{0x71,0x00},
		{0x72,0x00},
		{0x73,0x00},
		{0x74,0x00},
		{0x75,0x00},
		{0x76,0x00},
		{0x77,0x00},
		{0x78,0x00},
		{0x79,0x00},
		{0x7A,0x00},
		{0x7B,0x00},
		{0x7C,0x00},
		{0x7D,0x00},
		{0x7E,0x00},
		{0x7F,0x00},
};

const struct PMD3140_Register page3ConfigRegDefault[121]={
		{0x00,0x03},
		{0x08,0x7F},
		{0x09,0xFF},
		{0x0A,0xFF},
		{0x0B,0xFF},
		{0x0C,0x00},
		{0x0D,0x00},
		{0x0E,0x00},
		{0x0F,0x00},
		{0x10,0x00},
		{0x11,0x00},
		{0x12,0x00},
		{0x13,0x00},
		{0x14,0x00},
		{0x15,0x00},
		{0x16,0x00},
		{0x17,0x00},
		{0x18,0x00},
		{0x19,0x00},
		{0x1A,0x00},
		{0x1B,0x00},
		{0x1C,0x7F},
		{0x1D,0xFF},
		{0x1E,0xFF},
		{0x1F,0xFF},
		{0x20,0x00},
		{0x21,0x00},
		{0x22,0x00},
		{0x23,0x00},
		{0x24,0x00},
		{0x25,0x00},
		{0x26,0x00},
		{0x27,0x00},
		{0x28,0x00},
		{0x29,0x00},
		{0x2A,0x00},
		{0x2B,0x00},
		{0x2C,0x00},
		{0x2D,0x00},
		{0x2E,0x00},
		{0x2F,0x00},
		{0x30,0x7F},
		{0x31,0xFF},
		{0x32,0xFF},
		{0x33,0xFF},
		{0x34,0x00},
		{0x35,0x00},
		{0x36,0x00},
		{0x37,0x00},
		{0x38,0x00},
		{0x39,0x00},
		{0x3A,0x00},
		{0x3B,0x00},
		{0x3C,0x00},
		{0x3D,0x00},
		{0x3E,0x00},
		{0x3F,0x00},
		{0x40,0x00},
		{0x41,0x00},
		{0x42,0x00},
		{0x43,0x00},
		{0x44,0x7F},
		{0x45,0xFF},
		{0x46,0xFF},
		{0x47,0xFF},
		{0x48,0x00},
		{0x49,0x00},
		{0x4A,0x00},
		{0x4B,0x00},
		{0x4C,0x00},
		{0x4D,0x00},
		{0x4E,0x00},
		{0x4F,0x00},
		{0x50,0x00},
		{0x51,0x00},
		{0x52,0x00},
		{0x53,0x00},
		{0x54,0x00},
		{0x55,0x00},
		{0x56,0x00},
		{0x57,0x00},
		{0x58,0x7F},
		{0x59,0xFF},
		{0x5A,0xFF},
		{0x5B,0xFF},
		{0x5C,0x00},
		{0x5D,0x00},
		{0x5E,0x00},
		{0x5F,0x00},
		{0x60,0x00},
		{0x61,0x00},
		{0x62,0x00},
		{0x63,0x00},
		{0x64,0x00},
		{0x65,0x00},
		{0x66,0x00},
		{0x67,0x00},
		{0x68,0x00},
		{0x69,0x00},
		{0x6A,0x00},
		{0x6B,0x00},
		{0x6C,0x7F},
		{0x6D,0xFF},
		{0x6E,0xFF},
		{0x6F,0xFF},
		{0x70,0x00},
		{0x71,0x00},
		{0x72,0x00},
		{0x73,0x00},
		{0x74,0x00},
		{0x75,0x00},
		{0x76,0x00},
		{0x77,0x00},
		{0x78,0x00},
		{0x79,0x00},
		{0x7A,0x00},
		{0x7B,0x00},
		{0x7C,0x00},
		{0x7D,0x00},
		{0x7E,0x00},
		{0x7F,0x00},
};

const struct PMD3140_Register page4ConfigRegDefault[77]={
		{0x00,0x04},
		{0x08,0x7F},
		{0x09,0xFF},
		{0x0A,0xFF},
		{0x0B,0xFF},
		{0x0C,0x00},
		{0x0D,0x00},
		{0x0E,0x00},
		{0x0F,0x00},
		{0x10,0x00},
		{0x11,0x00},
		{0x12,0x00},
		{0x13,0x00},
		{0x14,0x00},
		{0x15,0x00},
		{0x16,0x00},
		{0x17,0x00},
		{0x18,0x00},
		{0x19,0x00},
		{0x1A,0x00},
		{0x1B,0x00},
		{0x1C,0x7F},
		{0x1D,0xFF},
		{0x1E,0xFF},
		{0x1F,0xFF},
		{0x20,0x00},
		{0x21,0x00},
		{0x22,0x00},
		{0x23,0x00},
		{0x24,0x00},
		{0x25,0x00},
		{0x26,0x00},
		{0x27,0x00},
		{0x28,0x00},
		{0x29,0x00},
		{0x2A,0x00},
		{0x2B,0x00},
		{0x2C,0x00},
		{0x2D,0x00},
		{0x2E,0x00},
		{0x2F,0x00},
		{0x30,0x7F},
		{0x31,0xFF},
		{0x32,0xFF},
		{0x33,0xFF},
		{0x34,0x00},
		{0x35,0x00},
		{0x36,0x00},
		{0x37,0x00},
		{0x38,0x00},
		{0x39,0x00},
		{0x3A,0x00},
		{0x3B,0x00},
		{0x3C,0x00},
		{0x3D,0x00},
		{0x3E,0x00},
		{0x3F,0x00},
		{0x40,0x00},
		{0x41,0x00},
		{0x42,0x00},
		{0x43,0x00},
		{0x44,0x7F},
		{0x45,0xFF},
		{0x46,0xFF},
		{0x47,0xFF},
		{0x48,0x7F},
		{0x49,0xFF},
		{0x4A,0xFF},
		{0x4B,0xFF},
		{0x4C,0x00},
		{0x4D,0x00},
		{0x4E,0x00},
		{0x4F,0x00},
		{0x50,0x00},
		{0x51,0x00},
		{0x52,0x00},
		{0x53,0x00}
};

struct PMD3140_Register page0ConfigReg[49]={
		{0x00,0x00},
		{0x01,0x00},
		{0x02,0x01},
		{0x07,0x60},
		{0x08,0x00},
		{0x09,0x00},
		{0x0A,0x00},
		{0x0B,0x00},
		{0x0C,0x20},
		{0x0D,0x00},
		{0x0E,0x00},
		{0x13,0x02},
		{0x14,0x48},
		{0x15,0xFF},
		{0x16,0x10},
		{0x1F,0x40},
		{0x20,0x00},
		{0x21,0x22},
		{0x22,0x41},
		{0x29,0x00},
		{0x2A,0x00},
		{0x2B,0x40},
		{0x2F,0x00},
		{0x32,0x00},
		{0x33,0xFF},
		{0x36,0x00},
		{0x3B,0x60},
		{0x3C,0x40},
		{0x3E,0xC9},
		{0x3F,0x80},
		{0x40,0x00},
		{0x41,0x40},
		{0x43,0xC9},
		{0x44,0x80},
		{0x45,0x00},
		{0x48,0xC9},
		{0x49,0x80},
		{0x4A,0x00},
		{0x4D,0xC9},
		{0x4E,0x80},
		{0x4F,0x00},
		{0x6B,0x01},
		{0x6C,0x60},
		{0x73,0xC0},
		{0x74,0xC0},
		{0x75,0xE0},
		{0x76,0x00},
		{0x77,0x80},
		{0x7E,0x00}
};

struct PMD3140_Register page1ConfigReg[2]={
		{0x1E,0x20},
		{0x1F,0x08}
};

struct PMD3140_Register page2ConfigReg[121]={
		{0x00,0x02},
		{0x08,0x7F},
		{0x09,0xFF},
		{0x0A,0xFF},
		{0x0B,0xFF},
		{0x0C,0x00},
		{0x0D,0x00},
		{0x0E,0x00},
		{0x0F,0x00},
		{0x10,0x00},
		{0x11,0x00},
		{0x12,0x00},
		{0x13,0x00},
		{0x14,0x00},
		{0x15,0x00},
		{0x16,0x00},
		{0x17,0x00},
		{0x18,0x00},
		{0x19,0x00},
		{0x1A,0x00},
		{0x1B,0x00},
		{0x1C,0x7F},
		{0x1D,0xFF},
		{0x1E,0xFF},
		{0x1F,0xFF},
		{0x20,0x00},
		{0x21,0x00},
		{0x22,0x00},
		{0x23,0x00},
		{0x24,0x00},
		{0x25,0x00},
		{0x26,0x00},
		{0x27,0x00},
		{0x28,0x00},
		{0x29,0x00},
		{0x2A,0x00},
		{0x2B,0x00},
		{0x2C,0x00},
		{0x2D,0x00},
		{0x2E,0x00},
		{0x2F,0x00},
		{0x30,0x7F},
		{0x31,0xFF},
		{0x32,0xFF},
		{0x33,0xFF},
		{0x34,0x00},
		{0x35,0x00},
		{0x36,0x00},
		{0x37,0x00},
		{0x38,0x00},
		{0x39,0x00},
		{0x3A,0x00},
		{0x3B,0x00},
		{0x3C,0x00},
		{0x3D,0x00},
		{0x3E,0x00},
		{0x3F,0x00},
		{0x40,0x00},
		{0x41,0x00},
		{0x42,0x00},
		{0x43,0x00},
		{0x44,0x7F},
		{0x45,0xFF},
		{0x46,0xFF},
		{0x47,0xFF},
		{0x48,0x00},
		{0x49,0x00},
		{0x4A,0x00},
		{0x4B,0x00},
		{0x4C,0x00},
		{0x4D,0x00},
		{0x4E,0x00},
		{0x4F,0x00},
		{0x50,0x00},
		{0x51,0x00},
		{0x52,0x00},
		{0x53,0x00},
		{0x54,0x00},
		{0x55,0x00},
		{0x56,0x00},
		{0x57,0x00},
		{0x58,0x7F},
		{0x59,0xFF},
		{0x5A,0xFF},
		{0x5B,0xFF},
		{0x5C,0x00},
		{0x5D,0x00},
		{0x5E,0x00},
		{0x5F,0x00},
		{0x60,0x00},
		{0x61,0x00},
		{0x62,0x00},
		{0x63,0x00},
		{0x64,0x00},
		{0x65,0x00},
		{0x66,0x00},
		{0x67,0x00},
		{0x68,0x00},
		{0x69,0x00},
		{0x6A,0x00},
		{0x6B,0x00},
		{0x6C,0x7F},
		{0x6D,0xFF},
		{0x6E,0xFF},
		{0x6F,0xFF},
		{0x70,0x00},
		{0x71,0x00},
		{0x72,0x00},
		{0x73,0x00},
		{0x74,0x00},
		{0x75,0x00},
		{0x76,0x00},
		{0x77,0x00},
		{0x78,0x00},
		{0x79,0x00},
		{0x7A,0x00},
		{0x7B,0x00},
		{0x7C,0x00},
		{0x7D,0x00},
		{0x7E,0x00},
		{0x7F,0x00},
};

struct PMD3140_Register page3ConfigReg[121]={
		{0x00,0x03},
		{0x08,0x7F},
		{0x09,0xFF},
		{0x0A,0xFF},
		{0x0B,0xFF},
		{0x0C,0x00},
		{0x0D,0x00},
		{0x0E,0x00},
		{0x0F,0x00},
		{0x10,0x00},
		{0x11,0x00},
		{0x12,0x00},
		{0x13,0x00},
		{0x14,0x00},
		{0x15,0x00},
		{0x16,0x00},
		{0x17,0x00},
		{0x18,0x00},
		{0x19,0x00},
		{0x1A,0x00},
		{0x1B,0x00},
		{0x1C,0x7F},
		{0x1D,0xFF},
		{0x1E,0xFF},
		{0x1F,0xFF},
		{0x20,0x00},
		{0x21,0x00},
		{0x22,0x00},
		{0x23,0x00},
		{0x24,0x00},
		{0x25,0x00},
		{0x26,0x00},
		{0x27,0x00},
		{0x28,0x00},
		{0x29,0x00},
		{0x2A,0x00},
		{0x2B,0x00},
		{0x2C,0x00},
		{0x2D,0x00},
		{0x2E,0x00},
		{0x2F,0x00},
		{0x30,0x7F},
		{0x31,0xFF},
		{0x32,0xFF},
		{0x33,0xFF},
		{0x34,0x00},
		{0x35,0x00},
		{0x36,0x00},
		{0x37,0x00},
		{0x38,0x00},
		{0x39,0x00},
		{0x3A,0x00},
		{0x3B,0x00},
		{0x3C,0x00},
		{0x3D,0x00},
		{0x3E,0x00},
		{0x3F,0x00},
		{0x40,0x00},
		{0x41,0x00},
		{0x42,0x00},
		{0x43,0x00},
		{0x44,0x7F},
		{0x45,0xFF},
		{0x46,0xFF},
		{0x47,0xFF},
		{0x48,0x00},
		{0x49,0x00},
		{0x4A,0x00},
		{0x4B,0x00},
		{0x4C,0x00},
		{0x4D,0x00},
		{0x4E,0x00},
		{0x4F,0x00},
		{0x50,0x00},
		{0x51,0x00},
		{0x52,0x00},
		{0x53,0x00},
		{0x54,0x00},
		{0x55,0x00},
		{0x56,0x00},
		{0x57,0x00},
		{0x58,0x7F},
		{0x59,0xFF},
		{0x5A,0xFF},
		{0x5B,0xFF},
		{0x5C,0x00},
		{0x5D,0x00},
		{0x5E,0x00},
		{0x5F,0x00},
		{0x60,0x00},
		{0x61,0x00},
		{0x62,0x00},
		{0x63,0x00},
		{0x64,0x00},
		{0x65,0x00},
		{0x66,0x00},
		{0x67,0x00},
		{0x68,0x00},
		{0x69,0x00},
		{0x6A,0x00},
		{0x6B,0x00},
		{0x6C,0x7F},
		{0x6D,0xFF},
		{0x6E,0xFF},
		{0x6F,0xFF},
		{0x70,0x00},
		{0x71,0x00},
		{0x72,0x00},
		{0x73,0x00},
		{0x74,0x00},
		{0x75,0x00},
		{0x76,0x00},
		{0x77,0x00},
		{0x78,0x00},
		{0x79,0x00},
		{0x7A,0x00},
		{0x7B,0x00},
		{0x7C,0x00},
		{0x7D,0x00},
		{0x7E,0x00},
		{0x7F,0x00},
};

struct PMD3140_Register page4ConfigReg[77]={
		{0x00,0x04},
		{0x08,0x7F},
		{0x09,0xFF},
		{0x0A,0xFF},
		{0x0B,0xFF},
		{0x0C,0x00},
		{0x0D,0x00},
		{0x0E,0x00},
		{0x0F,0x00},
		{0x10,0x00},
		{0x11,0x00},
		{0x12,0x00},
		{0x13,0x00},
		{0x14,0x00},
		{0x15,0x00},
		{0x16,0x00},
		{0x17,0x00},
		{0x18,0x00},
		{0x19,0x00},
		{0x1A,0x00},
		{0x1B,0x00},
		{0x1C,0x7F},
		{0x1D,0xFF},
		{0x1E,0xFF},
		{0x1F,0xFF},
		{0x20,0x00},
		{0x21,0x00},
		{0x22,0x00},
		{0x23,0x00},
		{0x24,0x00},
		{0x25,0x00},
		{0x26,0x00},
		{0x27,0x00},
		{0x28,0x00},
		{0x29,0x00},
		{0x2A,0x00},
		{0x2B,0x00},
		{0x2C,0x00},
		{0x2D,0x00},
		{0x2E,0x00},
		{0x2F,0x00},
		{0x30,0x7F},
		{0x31,0xFF},
		{0x32,0xFF},
		{0x33,0xFF},
		{0x34,0x00},
		{0x35,0x00},
		{0x36,0x00},
		{0x37,0x00},
		{0x38,0x00},
		{0x39,0x00},
		{0x3A,0x00},
		{0x3B,0x00},
		{0x3C,0x00},
		{0x3D,0x00},
		{0x3E,0x00},
		{0x3F,0x00},
		{0x40,0x00},
		{0x41,0x00},
		{0x42,0x00},
		{0x43,0x00},
		{0x44,0x7F},
		{0x45,0xFF},
		{0x46,0xFF},
		{0x47,0xFF},
		{0x48,0x7F},
		{0x49,0xFF},
		{0x4A,0xFF},
		{0x4B,0xFF},
		{0x4C,0x00},
		{0x4D,0x00},
		{0x4E,0x00},
		{0x4F,0x00},
		{0x50,0x00},
		{0x51,0x00},
		{0x52,0x00},
		{0x53,0x00}
};

uint8_t i2cTimeoutCounter=0;
bool bPCMD3140Page0DataCorrect=false;
bool bPCMD3140Page2DataCorrect=false;
bool bPCMD3140Page3DataCorrect=false;
bool bPCMD3140Page4DataCorrect=false;
uint8_t INT_ACT;
uint8_t errorCode=0;
bool bReadErrorCode=false;
bool bInterruptActive=false;
bool bErrorDetect=false;
uint32_t interruptActiveCount=0;
uint32_t interruptNonActiveCount=0;


bool isPCMD3140DataCorrect()
{
    if(bPCMD3140Page0DataCorrect&&bPCMD3140Page2DataCorrect&&bPCMD3140Page3DataCorrect&&bPCMD3140Page4DataCorrect)
    	return true;

    return 	false;
}

void setPage(uint8_t page)
{
	uint8_t wbuf[2];

	wbuf[0]=0x00;
	wbuf[1]=page;

	eeprom_pcmd3140_i2c_write(PCMD3140_SLAVE_ADDR,wbuf,2);
}


void dumpPage(uint8_t page)
{
    uint8_t wbuf[1];
    uint8_t rbuf[1];
    uint8_t cmd[3];
    uint8_t pageSize=0;
    struct PMD3140_Register* tempBuf=0;

    uint8_t sleepReg=0;
    bool bRestore=false;

    if(page!=0)
    {
      cmd[0] = 0;
      cmd[1] = 0x02;

      sleepReg=readRegFromPCDM3140WithPageParameters(cmd);

      FT_printf("sleepReg:%x\r\n",sleepReg);

      if((sleepReg&0x01)!=0x01)
      {
    	  cmd[0] = 0;
          cmd[1] = 0x02;
          cmd[2] = sleepReg|0x01;
          writeRegToPCDM3140WithPageParameters(cmd);
    	  bRestore=true;
    	  LL_mDelay(10);
      }
    }

    setPage(page);

    if(page==0)
	{
		pageSize=PAGE0_REG_MAX_SIZE;
		tempBuf=page0ConfigReg;
	}
    else if(page==1)
	{
		pageSize=PAGE1_REG_MAX_SIZE;
		tempBuf=page1ConfigReg;
	}
    else if(page==2)
	{
		pageSize=PAGE2_REG_MAX_SIZE;
		tempBuf=page2ConfigReg;
	}
    else if(page==3)
	{
		pageSize=PAGE3_REG_MAX_SIZE;
		tempBuf=page3ConfigReg;
	}
    else if(page==4)
    {
    	pageSize=PAGE4_REG_MAX_SIZE;
    	tempBuf=page4ConfigReg;
    }

    i2cTimeoutCounter=0;

    for(int i=0;i<pageSize;i++)
    {
	    wbuf[0]=tempBuf[i].regAddress;
	    if(eeprom_pcmd3140_i2c_write(PCMD3140_SLAVE_ADDR,wbuf,1)!=0)
	    {
		    i2cTimeoutCounter++;
		    if(i2cTimeoutCounter>=3)
		    {
			    i2cTimeoutCounter=0;
			    return;
		    }
		    else
		    {
			    continue;
		    }
	    }

	    i2cTimeoutCounter=0;

	    if(eeprom_pcmd3140_i2c_read(PCMD3140_SLAVE_ADDR,&rbuf[0],1)!=0)
	    {
		    i2cTimeoutCounter++;
		    if(i2cTimeoutCounter>=3)
		    {
			    i2cTimeoutCounter=0;
			    return;
		    }
		    else
		    {
			    continue;
		    }
	    }
	    if(tempBuf[i].data!=rbuf[0])
	    {
		    FT_printf("prv1Value:%x\r\n",tempBuf[i].data);

		    tempBuf[i].data=rbuf[0];
	    }



	    FT_printf("PAGE%d reg:%x value:%x\r\n",page,wbuf[0],rbuf[0]);
    }

    if(bRestore)
    {
    	cmd[0] = 0;
		cmd[1] = 0x02;
		cmd[2] = sleepReg;
		writeRegToPCDM3140WithPageParameters(cmd);
    }
}

int8_t getPageFromSRAM(uint8_t page,uint8_t *pageBuf,uint8_t pageSize)
{
	struct PMD3140_Register* tempBuf=0;
	int8_t result=0;

	if(page==0)
	{
		pageSize=PAGE0_REG_MAX_SIZE;
		tempBuf=&page0ConfigReg[0];
	}
	else if(page==1)
	{
		pageSize=PAGE1_REG_MAX_SIZE;
		tempBuf=&page1ConfigReg[0];
	}
	else if(page==2)
	{
		pageSize=PAGE2_REG_MAX_SIZE;
		tempBuf=&page2ConfigReg[0];
	}
	else if(page==3)
	{
		pageSize=PAGE3_REG_MAX_SIZE;
		tempBuf=&page3ConfigReg[0];
	}
	else if(page==4)
	{
		pageSize=PAGE4_REG_MAX_SIZE;
		tempBuf=&page4ConfigReg[0];
	}

	for(int i=0;i<pageSize;i++)
	{
		pageBuf[i]=tempBuf[i].data;
		FT_printf("tempBuf[%d].reg:%x\r\n",i,tempBuf[i].regAddress);
		FT_printf("pageBuf[%d]:%x\r\n",i,pageBuf[i]);
	}

	return result;
}

bool resetToDefault(uint8_t page)
{

#if 0
	uint8_t offset=0;
	uint8_t pageValueBuf[128];


	if(page==0)
	{
		for(offset=0;offset<PAGE0_REG_MAX_SIZE;offset++)
		{
			pageValueBuf[offset]=page0ConfigRegDefault[offset].data;
		}
		pageValueBuf[offset]= calculateChecksum(pageValueBuf,PAGE0_REG_MAX_SIZE);

		if(writePage(0,pageValueBuf,PAGE0_REG_MAX_SIZE,PAGE0_SIZE)!=0)
			return false;
	}
	else if(page==1)
	{
		for(offset=0;offset<PAGE1_REG_MAX_SIZE;offset++)
		{
		  pageValueBuf[offset]=page1ConfigRegDefault[offset].data;
		}
		pageValueBuf[offset]= calculateChecksum(pageValueBuf,PAGE1_REG_MAX_SIZE);

		if(writePage(1,pageValueBuf,PAGE1_REG_MAX_SIZE,PAGE1_SIZE)!=0)
			return false;
	}
	else if(page==2)
	{
		FT_printf("9999\r\n");

		for(offset=0;offset<PAGE2_REG_MAX_SIZE;offset++)
		{
		  pageValueBuf[offset]=page2ConfigRegDefault[offset].data;
		}

		pageValueBuf[offset]= calculateChecksum(pageValueBuf,PAGE2_REG_MAX_SIZE);

		if(writePage(2,pageValueBuf,PAGE2_REG_MAX_SIZE,PAGE2_SIZE)!=0)
			return false;
	}
	else if(page==3)
	{

		for(offset=0;offset<PAGE3_REG_MAX_SIZE;offset++)
		{
		  pageValueBuf[offset]=page3ConfigRegDefault[offset].data;
		}

		pageValueBuf[offset]= calculateChecksum(pageValueBuf,PAGE3_REG_MAX_SIZE);

		if(writePage(3,pageValueBuf,PAGE3_REG_MAX_SIZE,PAGE3_SIZE)!=0)
			return false;
	}
	else if(page==4)
	{
		for(offset=0;offset<PAGE4_REG_MAX_SIZE;offset++)
		{
		  pageValueBuf[offset]=page4ConfigRegDefault[offset].data;
		}
		pageValueBuf[offset]= calculateChecksum(pageValueBuf,PAGE4_REG_MAX_SIZE);

		if(writePage(4,pageValueBuf,PAGE4_REG_MAX_SIZE,PAGE4_SIZE)!=0)
			return false;
	}
#endif
	return true;

}

uint8_t readRegFromPCDM3140(uint8_t *cmd)
{
	uint8_t wbuf[1];
	uint8_t rbuf[1]={0xff};

	wbuf[0]=cmd[0];

	eeprom_pcmd3140_i2c_write(PCMD3140_SLAVE_ADDR,wbuf,1);

	eeprom_pcmd3140_i2c_read(PCMD3140_SLAVE_ADDR,&rbuf[0],1);

	return rbuf[0];
}

uint8_t readRegFromPCDM3140WithPageParameters(uint8_t *cmd)
{
	uint8_t wbuf[1];
	uint8_t rbuf[1]={0xff};

	setPage(cmd[0]);

	wbuf[0]=cmd[1];

	eeprom_pcmd3140_i2c_write(PCMD3140_SLAVE_ADDR,wbuf,1);

	eeprom_pcmd3140_i2c_read(PCMD3140_SLAVE_ADDR,&rbuf[0],1);

	return rbuf[0];
}

bool writeRegToPCDM3140(uint8_t *cmd)
{
	uint8_t wbuf[2];


	wbuf[0]=cmd[0];
	wbuf[1]=cmd[1];

	if(eeprom_pcmd3140_i2c_write(PCMD3140_SLAVE_ADDR,wbuf,2)!=0)
	    return false;

	return true;
}

bool writeRegToPCDM3140WithPageParameters(uint8_t *cmd)
{
	uint8_t wbuf[2];


	setPage(cmd[0]);

	wbuf[0]=cmd[1];
	wbuf[1]=cmd[2];
	FT_printf("page:%x reg:%x dtat:%x\r\n",cmd[0],wbuf[0],wbuf[1]);
	if(eeprom_pcmd3140_i2c_write(PCMD3140_SLAVE_ADDR,wbuf,2)!=0)
	    return false;


	return true;
}

bool isUnUsedRegister(uint8_t reg)
{
    for(int i=0;i<8;i++)
    {
    	if(reg==unusedRegister[i].regAddress)
    		return true;
    }

    return false;
}

uint8_t writePCMD3140Page(uint8_t page,uint8_t *pageBuf,uint8_t bufSize,bool bypassChecksum)
{
	uint8_t checksum=0;
	uint8_t wbuf[2];
	struct PMD3140_Register *pageConfigReg=NULL;
	uint8_t numberOfReg=0;

	if(page == 0)
	{
		pageConfigReg=page0ConfigReg;
		numberOfReg=PAGE0_REG_MAX_SIZE;
	}
	else if(page == 1)
	{
		pageConfigReg=page1ConfigReg;
		numberOfReg=PAGE1_REG_MAX_SIZE;
	}
	else if(page == 2)
	{
		pageConfigReg=page2ConfigReg;
		numberOfReg=PAGE2_REG_MAX_SIZE;
	}
	else if(page == 3)
	{
		pageConfigReg=page3ConfigReg;
		numberOfReg=PAGE3_REG_MAX_SIZE;
	}
	else if(page == 4)
	{
		pageConfigReg=page4ConfigReg;
		numberOfReg=PAGE4_REG_MAX_SIZE;
	}

	if(!bypassChecksum)
	{
		checksum= calculateChecksum(pageBuf,numberOfReg);

		if(checksum!=pageBuf[numberOfReg])
		{
				return 2;
		}
	}

	uint8_t configData[numberOfReg];

	for(int offset=0;offset<numberOfReg;offset++)
	{
		pageConfigReg[offset].data=pageBuf[offset];
		if(page>=2)
		{
		    configData[offset]=pageBuf[offset];
		}
	}

	setPage(page);

	if(page>=2)
	{
		configData[0]=pageConfigReg[1].regAddress;

		if(eeprom_pcmd3140_i2c_write(PCMD3140_SLAVE_ADDR,configData,numberOfReg)!=0)
		{
			return 1;
		}
	}
	else
	{
		for(int i=0;i<numberOfReg;i++)
		{
			if(!isUnUsedRegister(pageConfigReg[i].regAddress))
			{
				wbuf[0]=pageConfigReg[i].regAddress;
				wbuf[1]=pageConfigReg[i].data;

				if(eeprom_pcmd3140_i2c_write(PCMD3140_SLAVE_ADDR,wbuf,2)!=0)
				{
					i2cTimeoutCounter++;
					if(i2cTimeoutCounter>=3)
					{
						i2cTimeoutCounter=0;
						return 1;
					}
					else
					{
						continue;
					}
				}

				if(pageConfigReg[i].regAddress==0x02)
					LL_mDelay(1);
			}
		}
	}
	return 0;
}

void PCMD3140_Interrupt_cb()
{
	if(LL_GPIO_IsInputPinSet(PCMD3140_INT_GPIO_Port,PCMD3140_INT_Pin) == INT_ACT)
	{
		if(!bInterruptActive)
		{
			FT_printf("Active\r\n");
			bInterruptActive=true;
			interruptNonActiveCount=0;
			bReadErrorCode=false;
			interruptActiveCount=HAL_GetTick();
		}

	}
	else
	{
		if(bInterruptActive)
		{
			FT_printf("Non Active\r\n");
			bInterruptActive=false;
			bReadErrorCode=false;
			interruptNonActiveCount=HAL_GetTick();;
			interruptActiveCount=0;
		}
	}

}

void processPCMD3140()
{

	if(!isPCMD3140DataCorrect())
	{
		if(getLedNotifyType()==LED_NOTIFY_TYPE_NONE)
	        setLedNotify(LED_NOTIFY_TYPE_PCMD_INIT_FAIL);
	}

	if(interruptActiveCount!=0)
	{
		if(HAL_GetTick()-interruptActiveCount>=20)
		{
			interruptActiveCount=0;
			bErrorDetect=true;
			bReadErrorCode=true;
			FT_printf("bErrorDetect true\r\n");
		}

	}

	if(interruptNonActiveCount!=0)
	{
		if(HAL_GetTick()-interruptNonActiveCount>=20)
		{
			interruptNonActiveCount=0;
			bErrorDetect=false;

			uint8_t cmd[2];
			cmd[0]=0;
			cmd[1]=0x36;
			errorCode = readRegFromPCDM3140WithPageParameters(cmd);

			FT_printf("error Code:%02x\r\n",errorCode);

			FT_printf("bErrorDetect false\r\n");
		}
	}

	if(bReadErrorCode)
	{
	    uint8_t cmd[2];
	    cmd[0]=0;
	    cmd[1]=0x36;
	    errorCode = readRegFromPCDM3140WithPageParameters(cmd);

	    FT_printf("error Code:%02x\r\n",errorCode);
	    bReadErrorCode=false;
	}

	if(errorCode&0x80)
	{
		setLedNotify(LED_NOTIFY_TYPE_ASI_BUS_CLOCK_ERROR);
	}
	else if(errorCode&0x40)
	{
		setLedNotify(LED_NOTIFY_TYPE_PLL_CLOCK_ERROR);
	}
	else if(errorCode&0x20)
	{
		setLedNotify(LED_NOTIFY_TYPE_ASI_INPUT_MIXING_SATURATION_ERROR);
	}
	else if(errorCode&0x10)
	{
		setLedNotify(LED_NOTIFY_TYPE_VAD_POWER_UP_DETECT);
	}
	else if(errorCode&0x08)
	{
		setLedNotify(LED_NOTIFY_TYPE_VAD_POWER_DOWN_DETECT);
	}
	else
	{
		if(getLedNotifyType()>=LED_NOTIFY_TYPE_ASI_BUS_CLOCK_ERROR&&getLedNotifyType()<=LED_NOTIFY_TYPE_VAD_POWER_DOWN_DETECT)
		    setLedNotify(LED_NOTIFY_TYPE_NONE);
	}

}

void init_PCMD3140_Interrupt()
{
	LL_EXTI_InitTypeDef EXTI_InitStruct = {0};

	LL_IOP_GRP1_EnableClock(LL_IOP_GRP1_PERIPH_GPIOB);

	LL_EXTI_SetEXTISource(LL_EXTI_CONFIG_PORTB, LL_EXTI_CONFIG_LINE4);

    /**/
    EXTI_InitStruct.Line_0_31 = LL_EXTI_LINE_4;
    EXTI_InitStruct.LineCommand = ENABLE;
    EXTI_InitStruct.Mode = LL_EXTI_MODE_IT;
    EXTI_InitStruct.Trigger = LL_EXTI_TRIGGER_RISING_FALLING;
    LL_EXTI_Init(&EXTI_InitStruct);

    /**/
    LL_GPIO_SetPinPull(PCMD3140_INT_GPIO_Port, PCMD3140_INT_Pin, LL_GPIO_PULL_NO);

    /**/
    LL_GPIO_SetPinMode(PCMD3140_INT_GPIO_Port, PCMD3140_INT_Pin, LL_GPIO_MODE_INPUT);

    /* EXTI interrupt init*/
    NVIC_SetPriority(EXTI4_15_IRQn, 0);
    NVIC_EnableIRQ(EXTI4_15_IRQn);
}

void init_PCMD3140_fail()
{
	FT_printf("init PCMD3140 fail\r\n");
	bPCMD3140Page0DataCorrect=false;
    setLedNotify(LED_NOTIFY_TYPE_PCMD_INIT_FAIL);
}

void init_PCMD3140()
{
	uint8_t wbuf[2];
	uint8_t pageValueBuf[128];

	if(getPageFromEEprom(BLOCK_ID_PAGE0,pageValueBuf,PAGE0_SIZE)==1)
	{
		bPCMD3140Page0DataCorrect=false;
	}
	else
	{
		for(int offset=0;offset<PAGE0_REG_MAX_SIZE;offset++)
		{
			page0ConfigReg[offset].data=pageValueBuf[offset];
		}
		bPCMD3140Page0DataCorrect=true;
	}


	if(getPageFromEEprom(BLOCK_ID_PAGE2,pageValueBuf,PAGE2_SIZE)==1)
	{
		bPCMD3140Page2DataCorrect=false;
	}
	else
	{
		for(int offset=0;offset<PAGE2_REG_MAX_SIZE;offset++)
		{
			page2ConfigReg[offset].data=pageValueBuf[offset];
		}
		bPCMD3140Page2DataCorrect=true;
	}

	if(getPageFromEEprom(BLOCK_ID_PAGE3,pageValueBuf,PAGE3_SIZE)==1)
	{
		bPCMD3140Page3DataCorrect=false;
	}
	else
	{
		for(int offset=0;offset<PAGE3_REG_MAX_SIZE;offset++)
		{
			page3ConfigReg[offset].data=pageValueBuf[offset];
		}
		bPCMD3140Page3DataCorrect=true;
	}

	if(getPageFromEEprom(BLOCK_ID_PAGE4,pageValueBuf,PAGE4_SIZE)==1)
	{
		bPCMD3140Page4DataCorrect=false;
	}
	else
	{
		for(int offset=0;offset<PAGE4_REG_MAX_SIZE;offset++)
		{
			page4ConfigReg[offset].data=pageValueBuf[offset];
		}
		bPCMD3140Page4DataCorrect=true;
	}

	if(isPCMD3140DataCorrect())
	{
		setPage(0);

		wbuf[0]=page0ConfigReg[2].regAddress;
		wbuf[1]=page0ConfigReg[2].data|0x01;
		eeprom_pcmd3140_i2c_write(PCMD3140_SLAVE_ADDR,wbuf,2);

		LL_mDelay(10);

		for(int offset=0;offset<PAGE0_REG_MAX_SIZE;offset++)
		{
			pageValueBuf[offset]=page0ConfigReg[offset].data;
		}

		if(writePCMD3140Page(0,pageValueBuf,PAGE0_REG_MAX_SIZE,true)!=0)
		{
			init_PCMD3140_fail();
			return;
		}

		for(int offset=0;offset<PAGE2_REG_MAX_SIZE;offset++)
		{
			pageValueBuf[offset]=page2ConfigReg[offset].data;
		}

		if(writePCMD3140Page(2,pageValueBuf,PAGE2_REG_MAX_SIZE,true)!=0)
		{
			init_PCMD3140_fail();
			return;
		}

		for(int offset=0;offset<PAGE3_REG_MAX_SIZE;offset++)
		{
			pageValueBuf[offset]=page3ConfigReg[offset].data;
		}

		if(writePCMD3140Page(3,pageValueBuf,PAGE3_REG_MAX_SIZE,true)!=0)
		{
			init_PCMD3140_fail();
			return;
		}

		for(int offset=0;offset<PAGE4_REG_MAX_SIZE;offset++)
		{
			pageValueBuf[offset]=page4ConfigReg[offset].data;
		}

		if(writePCMD3140Page(4,pageValueBuf,PAGE4_REG_MAX_SIZE,true)!=0)
		{
			init_PCMD3140_fail();
			return;
		}

		if((page0ConfigReg[17].data&0x20))
		{
			if((page0ConfigReg[24].data&0x80)!=0)
			{
				INT_ACT = SET;
			}
			else
			{
				INT_ACT = RESET;
			}

			init_PCMD3140_Interrupt();
		}
	}
	else
	{
		FT_printf("PCMD3140 Data not Correct\r\n");
		setLedNotify(LED_NOTIFY_TYPE_PCMD_INIT_FAIL);
	}

}

